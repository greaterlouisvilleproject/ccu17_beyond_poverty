---
title: "CCU17"
output: github_document
---

Loading libraries
```{r libraries, message = FALSE}
library(ggthemes)
library(classInt)
library(showtext)
library(feather)
library(survey)
library(tidyverse)
library(magrittr)
```

Pull Peers Function
```{r}
pull_peers_MSA<-function(data){
  all.peers <- filter(data, data$MSA %in% c("24340", "41180", "36420", "46140", "24860", "28940", "13820", "26900", "31140", "28140", "36540", "24660", "16740", "18140", "17140", "34980", "32820", "27260", "39580", "19380", "40060"))
  
  all.peers$baseline <- 1
  all.peers$current  <- 1
  
  all.peers$baseline[all.peers$MSA == 24340 | all.peers$MSA == 41180
                     |all.peers$MSA == 36420 | all.peers$MSA == 46140
                     |all.peers$MSA == 24860 | all.peers$MSA == 28940] <-0
  
  all.peers$current[all.peers$MSA == 27260 | all.peers$MSA == 39580
                    |all.peers$MSA == 19380 | all.peers$MSA == 40060] <-0
  all.peers
}

pull_peers_FIPS <- function(dat){
  all.peers <- subset(dat, dat$FIPS == 1073 | dat$FIPS == 37119
                      |dat$FIPS == 39061 |dat$FIPS == 39049
                      |dat$FIPS == 26081 |dat$FIPS == 37081
                      |dat$FIPS == 45045 |dat$FIPS == 18097
                      |dat$FIPS == 29095 |dat$FIPS == 47093
                      |dat$FIPS == 21111 |dat$FIPS == 47157
                      |dat$FIPS == 47037 |dat$FIPS == 40109
                      |dat$FIPS == 31055 |dat$FIPS == 29189
                      |dat$FIPS == 29510 |dat$FIPS == 40143
                      |dat$FIPS == 12031 |dat$FIPS == 37183
                      |dat$FIPS == 39113 |dat$FIPS == 51760
                      |dat$FIPS == "01073")
  all.peers$baseline <- 1
  all.peers$current <- 1
  all.peers$baseline[all.peers$FIPS==26081|all.peers$FIPS==29189
                     |all.peers$FIPS==29510|all.peers$FIPS==40109
                     |all.peers$FIPS==40143|all.peers$FIPS==45045
                     |all.peers$FIPS==47093]<-0
  all.peers$current[all.peers$FIPS== 12031|all.peers$FIPS==37183|
                      all.peers$FIPS==39113|all.peers$FIPS==51760]<-0
  all.peers
}
```

Data to read in an IPUMS download containing all ACS data since 2010. The package bigmemory uses storage space on a hard drive rather than RAM to store the original file before it is subset to peer cities.
```{r, eval = FALSE}
#read the file into memory
library(bigmemory)
data <- read.big.matrix('Original Data/usa_00029.csv', header = TRUE)

#create a logical vector indicating the positions of observations in peer MSAs
MSA_col <- data[,6]
MSA_lgl <- MSA_col %in% c(24340, 41180, 36420, 46140, 24860, 28940, 13820, 31140, 26900, 28140, 36540, 24660, 16740, 18140, 17140, 34980, 32820, 27260, 39580, 19380, 40060)

#create a logical vector indicating the positions of TULSA observations (discussed below)
PUMA_col  <- data[,7]
state_col <- data[,5]
PUMA_col_lgl <- PUMA_col %in% c(100, 1201, 1202, 1203, 1204, 1301, 1302, 1501, 1601,
                                1100, 1200, 1000, 900, 600, 800)
state_col_lgl <- state_col == 40
Tulsa_lgl <- PUMA_col_lgl & state_col_lgl

#combine the logical vectors and create a data frme in memory consisting of peer city observations
all_obs <- MSA_lgl | Tulsa_lgl
output <- data[all_obs,]
output <- as.data.frame(output)

#write the output to a file
write_feather(output, "data/all_obs.feather")  
```

## Code used to cut down dataset

The initial data comes from an IPUMS download which covers the whole U.S. I include the code I used to cut it down to the peer cities. The dataframe was called mpi_msa

Giving TULSA PUMAs the TULSA MSA. TULSA's PUMAs are not a 90%+ match for the TULSA MSA, so IPUMS does not include them. However, for the sake of our analysis we'll accept the geographical imprecision. The area included is larger than the TULSA MSA. 
```{r, eval = FALSE}
mpi_msa$MET2013[mpi_msa$PUMA == 100]  <- 46140 
mpi_msa$MET2013[mpi_msa$PUMA == 1201] <- 46140 
mpi_msa$MET2013[mpi_msa$PUMA == 1202] <- 46140 
mpi_msa$MET2013[mpi_msa$PUMA == 1203] <- 46140 
mpi_msa$MET2013[mpi_msa$PUMA == 1204] <- 46140 
mpi_msa$MET2013[mpi_msa$PUMA == 1301] <- 46140 
mpi_msa$MET2013[mpi_msa$PUMA == 1302] <- 46140 
mpi_msa$MET2013[mpi_msa$PUMA == 1501] <- 46140 
mpi_msa$MET2013[mpi_msa$PUMA == 1601] <- 46140 
```

Only Peer cities and only individuals not in group quarters (this is a normal exclusion made by factfinder as well). I am also cutting to just 2015, as the other two years aren't used. 
```{r, eval = FALSE}
mpi_msa <- mpi_msa %>% rename(MSA = MET2013)
mpi_msa <- pull_peers_MSA(mpi_msa)
mpi_msa <- mpi_msa %>% filter((GQ == 1 | GQ == 2) & YEAR == 2015)
```

Reading in data
```{r}
#mpi_msa <- read_feather("data/peer_acs_micro.feather")
mpi_msa <- read_feather("data/all_obs.feather")
```

## Microdata analysis

Matching FIPS numbers to recognizable names. 
```{r}
mpi_msa <- mpi_msa %>% rename(MSA = MET2013)
mpi_msa <- pull_peers_MSA(mpi_msa)
mpi_msa <- mpi_msa %>% filter(GQ == 1 | GQ == 2)

mpi_msa$city<-NA
mpi_msa$city[mpi_msa$MSA == 24340] = "Grand Rapids"
mpi_msa$city[mpi_msa$MSA == 41180] = "St. Louis"
mpi_msa$city[mpi_msa$MSA == 36420] = "Oklahoma City"
mpi_msa$city[mpi_msa$MSA == 46140] = "Tulsa"
mpi_msa$city[mpi_msa$MSA == 24860] = "Greenville"
mpi_msa$city[mpi_msa$MSA == 28940] = "Knoxville"
mpi_msa$city[mpi_msa$MSA == 13820] = "Birmingham"
mpi_msa$city[mpi_msa$MSA == 31140] = "Louisville"
mpi_msa$city[mpi_msa$MSA == 26900] = "Indianapolis"
mpi_msa$city[mpi_msa$MSA == 28140] = "Kansas City"
mpi_msa$city[mpi_msa$MSA == 36540] = "Omaha"
mpi_msa$city[mpi_msa$MSA == 24660] = "Greensboro"
mpi_msa$city[mpi_msa$MSA == 16740] = "Charlotte"
mpi_msa$city[mpi_msa$MSA == 18140] = "Columbus"
mpi_msa$city[mpi_msa$MSA == 17140] = "Cincinnati"
mpi_msa$city[mpi_msa$MSA == 34980] = "Nashville"
mpi_msa$city[mpi_msa$MSA == 32820] = "Memphis"
mpi_msa$city[mpi_msa$MSA == 27260] = "Jacksonville"
mpi_msa$city[mpi_msa$MSA == 39580] = "Raleigh"
mpi_msa$city[mpi_msa$MSA == 19380] = "Dayton"
mpi_msa$city[mpi_msa$MSA == 40060] = "Richmond"
```


Generating an indicator variable for whether or not the household has a child. This will allow me to subset to only households with children. (Rather than subsetting to only children).

```{r household has a child}
mpi_msa <- mpi_msa %>%
group_by(SERIAL, YEAR) %>%
   mutate(has_child = if_else(any(AGE < 18), 1, 0))
```

The income poverty indicator is straightforward and is the same for all members of the household. The ACS data already contains a poverty indicator showing percent of poverty line for all households. I recode this as a binary variable such that households are poor (1) or not poor (0)

I also filter out Group Quarters. 
```{r income}
mpi_msa$FTOTINC[mpi_msa$FTOTINC == 9999999] <- NA

mpi_msa$income_poverty = if_else(mpi_msa$POVERTY <= 100, 1, 0)
```

Family employment is also assigned at the household level. If no one in the family is employed, then the family is initially considered employment deprived. However, if anyone in the family has retirement income, or investment income in excess of $25,000, or if the family lives on a working farm, then the family is not considered employment deprived. 
```{r employment, message = FALSE}
mpi_msa$INCINVST[mpi_msa$INCINVST == 999999] <- 0
mpi_msa$INCRETIR[mpi_msa$INCRETIR == 999999] <- 0

mpi_msa <- mpi_msa %>%
  mutate(emp_num = if_else(EMPSTAT == 1, 1, 0)) %>%
  group_by(SERIAL, YEAR) %>%
   mutate(retired = if_else(any(INCRETIR > 20900), 1, 0),
         investment = if_else(any(INCINVST > 20900), 1, 0),
         fam_emp = if_else(any(emp_num ==1)|any(retired ==1)|any(investment == 1)|FARM == 2, 0, 1))

```

Family unemployment is also assigned at the household level, with unemployment used as an indicator for whether anyone in the family is looking for work.
```{r}
mpi_msa$unemployed <- NA
mpi_msa$unemployed[mpi_msa$EMPSTAT == 2] <- 1

mpi_msa <- mpi_msa %>% 
  group_by(SERIAL, YEAR) %>%
  mutate(hh_unemployment = if_else(any(unemployed == 1, na.rm = TRUE), 1, 0))
```

A dichotomous variable for if anyone in the household has an associate degree or higher
```{r education, message = FALSE}
mpi_msa = mpi_msa %>%
  group_by(SERIAL, YEAR) %>%
  mutate(fam_edu = if_else(any(EDUCD > 80), 0, 1))
```

A dichotomous variable for if anyone in the household has a high school degree or higher
```{r hs education, message = FALSE}
mpi_msa = mpi_msa %>%
  group_by(SERIAL, YEAR) %>%
  mutate(fam_no_hs_edu = if_else(any(EDUCD > 61), 0, 1))

```

Health insurance is assigned at the individual level. Some members of the household may have health insurance, while others do not. Children are more likely to have health insurance than adults. 
```{r health, message = FALSE}
mpi_msa$health = if_else(mpi_msa$HCOVANY == 2, 0, 1)
```

Education
```{r}
mpi_msa$education = if_else(mpi_msa$EDUCD < 62 & mpi_msa$AGE > 18 & mpi_msa$EDUCD !=1, 1, 0) #less than hs, over 18, not NA

mpi_msa$grade_recode = NA ##where GRADEATTD == 0, it stays NA, everywhere else it changes. 0 is NA in GRADEATTD codebook
mpi_msa$grade_recode[mpi_msa$GRADEATTD < 30 & mpi_msa$GRADEATTD != 0] = 0
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 30] = 4
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 31] = 1
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 32] = 2
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 33] = 3
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 34] = 4
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 40] = 8
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 41] = 5
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 42] = 6
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 43] = 7
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 44] = 8
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 50] = 12
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 51] = 9
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 52] = 10
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 53] = 11
mpi_msa$grade_recode[mpi_msa$GRADEATTD == 54] = 12
mpi_msa$grade_recode[mpi_msa$GRADEATTD > 59] = 120

mpi_msa$education[mpi_msa$AGE < 19 & ((mpi_msa$GRADEATTD+6) < mpi_msa$AGE)] = 1 ##If age is more than 6 years above grade level
```

## Housing Quality

#### Overcrowding
Overcrowding is assigned at the household level. The individuals in the household are assigned the status of overcrowded if there are more than two people per bedroom. 
```{r overcrowding, message = FALSE}
mpi_msa = mpi_msa %>%
  group_by(SERIAL, YEAR) %>%
  mutate(hhsize = n())
           
mpi_msa$overcrowd = if_else(mpi_msa$hhsize > 2*mpi_msa$BEDROOMS, 1, 0)
```

#### Housing costs
Houses are considered cost burdened at above 30% of total income and severely cost burdened at over 50% of total income. Here I follow Dhongde and Haveman 2016 in using severe cost burden as the indicator. 
```{r}
mpi_msa$OWNCOST[mpi_msa$OWNCOST == 99999] <- NA
mpi_msa$FTOTINC[mpi_msa$FTOTINC == 99999] <- NA

mpi_msa$hcost <- apply(mpi_msa[ ,c("OWNCOST", "RENTGRS")], 1, max, na.rm = TRUE)
mpi_msa$hcost_burdened <- if_else(mpi_msa$hcost*12/mpi_msa$FTOTINC > .50, 1, 0) # HUD uses 50% as severe cost burdened
mpi_msa$hcost_burdened[is.na(mpi_msa$hcost_burdened)] <- 0

mpi_msa$rent <- if_else(mpi_msa$RENTGRS > 0 & is.na(mpi_msa$OWNCOST), 1, 0) 

```


```{r}
mpi_msa$percent_housing <- (mpi_msa$hcost*12)/mpi_msa$FTOTINC
```

#### Internet/Computer Access
Internet access is assigned at the household level. A household is considered deprived if there is either no internet access, or there is none of the following computer equipment: laptop, desktop, notebook, smartphone, other computer equipment (not including GPS or household appliances). 
```{r internet}
mpi_msa$computer_internet <- if_else(mpi_msa$CINETHH == 3|(mpi_msa$CILAPTOP == 2 & mpi_msa$CIHAND == 2 & mpi_msa$CIOTHCOMP == 2), 1, 0)

```

And indicator variable for if the family is both in poverty and has at least one person working.
```{r poor and working}
mpi_msa$poor_and_working = if_else(mpi_msa$income_poverty == 1 & mpi_msa$fam_emp == 0, 1, 0)
```

Creating a dataframe with one entry per household. (Note: remember to use HHWT instead of PERWT when creating survey weights for this.)
```{r}
mpi_hhold <- subset(mpi_msa, !duplicated(SERIAL))
```

```{r custom not-in function}
`%!in%` <- negate(`%in%`)
```

#Tenure analysis
The percent of children who moved homes in the past year was added after the original statistics were produced, so the data comes from a separate download.

Read in data
```{r}
housing_data <- read_feather("data/peer_housing_micro.feather")
```

This is the data used to trim the original housing data set. semi_join returns all rows of the first dataframe where there are matches in the second.
```{r, eval = FALSE}
housing_data <- semi_join(housing_data, mpi_msa, by = c("YEAR", "DATANUM", "SERIAL", "PERNUM"))
```

Add housing data to the mpi_msa dataframe
```{r}
housing_data <- housing_data %>%
  select(DATANUM, SERIAL, PERNUM, MIGRATE1, MOVEDIN)

mpi_msa <- full_join(mpi_msa, housing_data, cy = c("DATANUM", "SERIAL", "PERNUM"))
```

MOVEDIN is the number of years since the occupant moved into the residence. It is 0 for members of the family that are not the head of the household, so the value for the head of household is applied to other family members. 
A value of 1 is assigned if the child's family has moved in the last year, otherwise it is 0.

```{r}
mpi_msa <- mpi_msa %>% 
  group_by(YEAR, SERIAL) %>%
  mutate(year_moved = max(MOVEDIN))

mpi_msa$moved <- if_else(mpi_msa$MIGRATE1 == 1, 0, 1)
mpi_msa$moved[mpi_msa$MIGRATE1 == 0] <- NA
mpi_msa$moved[mpi_msa$year_moved == 1] <- 1
```


Setting up survey objects of both individuals and households for current peer cities
```{r}
mpi_msa_current <- mpi_msa %>% 
  filter(MSA %!in% c("27260", "39580", "19380", "40060"))

mpi_hhold_current <- mpi_hhold %>% 
  filter(MSA %!in% c("27260", "39580", "19380", "40060"))


mpi_msa_svy <- svydesign(ids = ~1, weights = ~PERWT, data = mpi_msa_current)
mpi_msa_svy_ch <- subset(mpi_msa_svy, AGE < 18)
mpi_msa_svy_ch_pov <- subset(mpi_msa_svy_ch, income_poverty == 1)
mpi_msa_svy_ch_no_pov <- subset(mpi_msa_svy_ch, income_poverty == 0)
mpi_msa_svy_ch_wp <- subset(mpi_msa_svy_ch_pov, fam_emp == 1)

mpi_hhold_svy <- svydesign(ids = ~1, weights = ~HHWT, data = mpi_hhold_current)
mpi_hhold_svy_pov <- subset(mpi_hhold_svy, income_poverty == 1)
mpi_hhold_svy_ch <- subset(mpi_hhold_svy, has_child == 1)
mpi_hhold_svy_ch_pov <- subset(mpi_hhold_svy_ch, income_poverty == 1)
mpi_hhold_svy_ch_no_pov <- subset(mpi_hhold_svy_ch, income_poverty == 0)
mpi_hhold_svy_ch_wp <- subset(mpi_hhold_svy_ch_pov, fam_emp == 1)
```

Start adding svyby data here and then later merge all of those tables together before graphing. 
```{r, message = FALSE}
mpi_lou_hhold_svy_ch_pov <- subset(mpi_hhold_svy_ch_pov, city == "Louisville")

ch_pov_df <- svyby(~income_poverty, ~city, design = mpi_msa_svy_ch, svymean, na.rm = TRUE) %>% select(-se)

income_ch_pov_df <- svyby(~FTOTINC, ~city, design = mpi_msa_svy_ch_pov, svyquantile, quantiles = .5, ci = TRUE, na.rm = TRUE)

unemp_svy_pov_df <- svyby(~hh_unemployment, ~city, design = mpi_hhold_svy_ch_pov, svymean, na.rm = TRUE) %>%
  select(city, hh_unemployment_pov = hh_unemployment)

unemp_svy_no_pov_df <- svyby(~hh_unemployment, ~city, design = mpi_hhold_svy_ch_no_pov, svymean, na.rm = TRUE) %>%
  select(city, hh_unemployment_no_pov = hh_unemployment)

emp_svy_df <- svyby(~fam_emp, ~city, design = mpi_hhold_svy_ch_pov, svymean, na.rm = TRUE) %>%
  mutate(pct_emp = 1 - fam_emp) %>%
  select(city, pct_emp)

hcost_ch_pov_df <- svyby(~hcost_burdened, ~city, design = mpi_msa_svy_ch_pov, svymean, na.rm = TRUE)
hcost_ch_pov_and_no_pov_df <- svyby(~hcost_burdened, ~city+income_poverty, design = mpi_msa_svy_ch, svymean, na.rm = TRUE)

hcost_per_ch_df <- svyby(~percent_housing, ~city+income_poverty, design = mpi_hhold_svy_ch, svyquantile, quantiles = .5, ci = TRUE, na.rm = TRUE)
hcost_per_ch_df <- hcost_per_ch_df %>%
  select(city, income_poverty, percent_housing) %>%
  spread(key = income_poverty, value = percent_housing) %>%
  rename(poor_per_housing = `1`, not_poor_per_housing = `0`) %>%
  mutate(ratio_housing_gap = poor_per_housing / not_poor_per_housing)


income_hhold_ch_pov_df <- svyby(~FTOTINC, ~city, design = mpi_hhold_svy_ch_pov, svyquantile, quantiles = .5, ci = TRUE, na.rm = TRUE)
income_hhold_ch_pov_df <- income_hhold_ch_pov_df  %>% rename(median_hhold_income_child = FTOTINC)

income_hhold_pov_df <- svyby(~FTOTINC, ~city, design = mpi_hhold_svy_pov, svyquantile, quantiles = .5, ci = TRUE, na.rm = TRUE)
income_hhold_pov_df <- income_hhold_pov_df  %>% rename(median_hhold_income_all = FTOTINC)

educ_ch_pov_df <- svyby(~fam_edu, ~city+income_poverty, design = mpi_msa_svy_ch, svymean) 
educ_ch_pov_df <- educ_ch_pov_df %>%
  select(city, income_poverty, fam_edu) %>%
  spread(key = income_poverty, value = fam_edu) %>%
  rename(poor_no_assoc = `1`, not_poor_no_assoc = `0`)

educ_no_hs_ch_pov_df <- svyby(~fam_no_hs_edu, ~city+income_poverty, design = mpi_msa_svy_ch, svymean) 

educ_no_hsdf <- svyby(~fam_no_hs_edu, ~city+income_poverty, design = mpi_msa_svy_ch, svymean)

educ_no_hs_ch_pov_df <- educ_no_hs_ch_pov_df %>%
  select(city, income_poverty, fam_no_hs_edu) %>%
  spread(key = income_poverty, value = fam_no_hs_edu) %>%
  rename(poor_no_hs = `1`, not_poor_no_hs = `0`)

housing_svy_df <- svyby(~moved, ~city+income_poverty, design = mpi_msa_svy_ch, svymean, na.rm = TRUE)%>%
  select(city, income_poverty, moved) %>%
  spread(key = income_poverty, value = moved) %>%
  rename(poor_moved = `1`, not_poor_moved = `0`)

```

Merging into just one dataframe
```{r}
graph_df <- left_join(income_ch_pov_df, income_hhold_ch_pov_df, by = "city")
graph_df <- left_join(graph_df, income_hhold_pov_df, by = "city")
graph_df <- left_join(graph_df, unemp_svy_pov_df, by = "city")
graph_df <- left_join(graph_df, unemp_svy_no_pov_df, by = "city")
graph_df <- left_join(graph_df, educ_ch_pov_df, by = "city")
graph_df <- left_join(graph_df, educ_no_hs_ch_pov_df, by = "city")
graph_df <- left_join(graph_df, hcost_ch_pov_df, by = "city")
graph_df <- left_join(graph_df, hcost_per_ch_df, by = "city")
graph_df <- left_join(graph_df, housing_svy_df, by = "city")
graph_df <- left_join(graph_df, emp_svy_df, by = "city")

graph_df <- graph_df %>% select(-se.x, -se.y, -se.x.x, -se.y.y, -FTOTINC)

rescale <- function(x){new_value <- x*100}
graph_df[ ,c(3:12, 14:16)] = apply(graph_df[ ,c(3:12, 14:16)], 2, rescale)
```

```{r rank graph function}
rank_and_nb_group<-function(df, var, order="Descending",
                            plot_title="", subtitle = "", y_title = "Percent", caption_text = "",
                            sigfig = 3, num_dec = 1, text = TRUE, h_line = FALSE){
  df$var <- df[[var]]
  if(order=="Descending"){
    d.order<-df[order(-df$var),]
  }
  if(order=="Ascending"){
    d.order<-df[order(df$var),]
  }
  ranks<-1:length(df$var)
  d.rank<-cbind(d.order,ranks)
  names<-paste(d.rank$ranks,".",sep="")
  names<-paste(names,d.rank$city)
  d.graph<-cbind(d.rank,names)
  
  breaks <- classIntervals(d.graph$var,3,style="jenks")
  d.graph$color <- NA
  d.graph$color[d.graph$var<=breaks$brks[2]] <- "green"
  d.graph$color[d.graph$var>breaks$brks[2] & d.graph$var<=breaks$brks[3]] <- "yellow"
  d.graph$color[d.graph$var>breaks$brks[3]] <- "red"
  d.graph$round <- format(round(signif(d.graph$var, digits = sigfig), digits = num_dec))
  d.graph$textfont <- "Museo Sans 300"
  d.graph$textfont[d.graph$city == "Louisville"] <- "Museo Sans 300 Italic"
  d.graph$linecolor <- "white"
  d.graph$linecolor[d.graph$city == "Louisville"] <- "#00a9b7"
  d.graph$textcolor <- "black"
  d.graph$textcolor[d.graph$city == "Louisville"] <- "#00a9b7"
  
  
  p <- ggplot(data=d.graph,aes(x=factor(names, levels=rev(unique(names))),
                               y=var,fill=factor(color)))+guides(fill=FALSE)
  p <- p+geom_bar(stat="identity",color=rev(d.graph$linecolor), size = 1)+coord_flip()+theme_tufte()
  if(order=="Ascending"){
    p <- p+scale_fill_manual(values=c("#96ca4f","#db2834","#ffd600"))
  }
  if(order=="Descending"){
    p <- p+scale_fill_manual(values=c("#db2834","#96ca4f","#ffd600"))
  }
  p <- p + theme(text = element_text(family = "Museo Sans 300"),
                 plot.title = element_text(size = 36, hjust = 0.5),
                 axis.text.y=element_text(hjust=0, family = rev(d.graph$textfont),
                                          size=24, color = rev(d.graph$textcolor)),
                 axis.ticks=element_blank(),
                 axis.text.x = element_blank(),
                 axis.title.x = element_text(size = 24),
                 plot.caption = element_text(size = 18),
                 plot.subtitle = element_text(size = 24, hjust = 0.5))
  if (text == TRUE) {
    p <-
      p + geom_text(
        aes(label = round),
        hjust = 1.1,
        size = 10,
        family = "Museo Sans 300"
      )
  }
  if (h_line == TRUE){
    p <- p + geom_hline(yintercept = 0, linetype = "longdash", size = 1)
  }
  p <- p+labs(title = plot_title, y= y_title, subtitle = subtitle,
              x = "", caption = caption_text)
  p
}

```

Adding fonts
```{r font add}
font.add("Museo Sans 300", "MuseoSans_300.otf")
font.add("Museo Sans 300 Italic", "MuseoSans_300_Italic.otf")
```

Writing images
```{r images}

showtext.auto()

jpeg("images/ccu17_median_hhold_income_poor_ch.jpg", 1800, 1200, res = 100)
rank_and_nb_group(graph_df, "median_hhold_income_child", order = "Descending",
                  plot_title = "Median income of households in poverty with children, 2015",
                  caption_text = "Source: Greater Louisville Project Analysis of\nAmerican Community Survey Microdata Data via IPUMS")
dev.off()

#jpeg("images/ccu17_hh_pov_unemployment.jpg", 1800, 1200, res = 100)
#rank_and_nb_group(graph_df, "hh_unemployment", order = "Ascending",
#                  plot_title = "Households in poverty with children where\nsomeone is unemployed, 2015",
#                  caption_text = "Source: Greater Louisville Project Analysis of\nAmerican Community Survey Microdata Data via IPUMS")
#dev.off()


jpeg("images/ccu17_poor_no_assoc.jpg", 1800, 1200, res = 100)
rank_and_nb_group(graph_df, "poor_no_assoc", order = "Ascending",
                  plot_title = "Children in poverty in households where no one has \nan associate degree or higher, 2015",
                  caption_text = "Source: Greater Louisville Project Analysis of\nAmerican Community Survey Microdata Data via IPUMS")
dev.off()

jpeg("images/ccu17_poor_no_hs.jpg", 1800, 1200, res = 100)
rank_and_nb_group(graph_df, "poor_no_hs", order = "Descending",
                  plot_title = "Children in poverty in households where no one has \na high school degree or equivalent, 2015",
                  caption_text = "Source: Greater Louisville Project Analysis of\nAmerican Community Survey Microdata Data via IPUMS")
dev.off()

jpeg("images/ccu17_median_poor_hhold_all.jpg", 1800, 1200, res = 100)
rank_and_nb_group(graph_df, "median_hhold_income_all", order = "Descending",
                  plot_title = "Median Income of Households in Poverty, 2015",
                  caption_text = "Source: Greater Louisville Project Analysis of\nAmerican Community Survey Microdata Data via IPUMS")
dev.off()

jpeg("images/ccu17_housing_burden_poor_ch.jpg", 1800, 1200, res = 100)
rank_and_nb_group(graph_df, "hcost_burdened", order = "Ascending",
                  plot_title = "Poor children in families paying over half their income \nin housing costs, 2015",
                  caption_text = "Source: Greater Louisville Project Analysis of\nAmerican Community Survey Microdata Data via IPUMS")
dev.off()

jpeg("images/ccu17_percent_on_housing.jpg", 1800, 1200, res = 100)
rank_and_nb_group(graph_df, "ratio_housing_gap", order = "Ascending",
                  plot_title = "Ratio of median percent of income spent on housing by households in poverty with children\n and households not in poverty with children, 2015",
                  caption_text = "Source: Greater Louisville Project Analysis of\nAmerican Community Survey Microdata Data via IPUMS")
dev.off()

jpeg("images/ccu17_pct_poor_children_moved.jpg", 1800, 1200, res = 100)
rank_and_nb_group(graph_df, "poor_moved", order = "Ascending",
                  plot_title = "Poor children who moved homes in the last twelve months, 2015",
                  subtitle = "Three-year average",
                  caption_text = "Source: Greater Louisville Project Analysis of\nAmerican Community Survey Microdata Data via IPUMS")
dev.off()

jpeg("images/ccu17_pct_poor_hh_employed.jpg", 1800, 1200, res = 100)
rank_and_nb_group(graph_df, "pct_emp", order = "Ascending",
                  plot_title = "Households in poverty with children\nwhere someone is employed, 2015",
                  caption_text = "Source: Greater Louisville Project Analysis of\nAmerican Community Survey Microdata Data via IPUMS")
dev.off()
```

# College and Career Ready

```{r}
df_ccr    <- read_csv("data/jeffcograds.csv", col_types = cols(NBR_CCR_REGULAR = col_character()))
df_kready <- read_csv("data/jeffcokready1617.csv", skip = 1)

df_ccr <- df_ccr %>%
  filter(SCH_NAME == "---District Total---") %>%
  filter(CNTYNAME == "JEFFERSON") %>%
  filter(DISAGG_LABEL == "All Students" | DISAGG_LABEL == "Free/Reduced-Price Meals") %>%
  select(DISAGG_LABEL, NBR_GRADUATES_WITH_DIPLOMA, NBR_CCR_REGULAR) %>%
  transmute(Demographic = DISAGG_LABEL,
            total_grads = as.numeric(gsub(",|\\*", "", NBR_GRADUATES_WITH_DIPLOMA)),
            ccr_grads = as.numeric(gsub(",", "", NBR_CCR_REGULAR)),
            not_ccr_grads = total_grads - ccr_grads)

df_kready <- df_kready %>% 
  filter(`Prior Setting` == "All Students" ) %>%
  filter(`School Name` == "-- District Total --") %>%
  filter(`District Name` == "Jefferson County") %>%
  filter(Demographic == "All Students" | Demographic == "Free Reduced Price Meals") %>%
  select(Demographic, `Number Tested`, `Not Ready`, `Kindergarten Ready`) %>%
  transmute(Demographic = Demographic,
            total_kind = as.numeric(gsub(",", "", `Number Tested`)),
            not_kready = total_kind * `Not Ready` / 100,
            kready = total_kind * `Kindergarten Ready` / 100)
  

df_ccr$Demographic[df_ccr$Demographic == "Free/Reduced-Price Meals"] <- "Free Reduced Price Meals"

df_jeff <- left_join(df_ccr, df_kready, by = "Demographic")
```

```{r, eval = SKIP}
df_jeff[3,] <- c("Non Free Reduced Price Meals", df_jeff[1, 2:7] - df_jeff[2, 2:7])

df_jeff <- df_jeff %>% 
  mutate(pct_ccr = ccr_grads/total_grads * 100,
         pct_kready = kready / total_kind * 100)
```

# Health Data from Health Inequality Project

Reading in the data
```{r}
health_df <- read_csv("data/merged health stl.csv")
```

creating new columns

```{r}
health_df <- within(health_df,{
  cur_smoke_q1 <- cur_smoke_q1*100
  bmi_obese_q1 <- bmi_obese_q1*100
  cur_smoke_q4 <- cur_smoke_q4*100
  bmi_obese_q4 <- bmi_obese_q4*100
  le_m_gap <- le_agg_q4_M - le_agg_q1_M
  le_raceadj_m_gap <- le_raceadj_q4_M - le_raceadj_q1_M
  le_f_gap <- le_agg_q4_F - le_agg_q1_F
  le_raceadj_f_gap <- le_raceadj_q4_F - le_raceadj_q1_F
  smoke_gap <- cur_smoke_q1 - cur_smoke_q4
  bmi_gap <- bmi_obese_q1 - bmi_obese_q4
})

health_df$city <- health_df$cz_name.x

```


the graphing function
```{r}
rank_and_nb_group_h<-function(df, var, order="Descending", peers="Current",
                            plot_title="", y_title = "Percent", caption_text = "",
                            sigfig = 3, num_dec = 1, text = TRUE, h_line = FALSE,
                            thousands_comma = T){
  df$var <- df[[var]]
  if(order=="Descending"){
    d.order<-df[order(-df$var),]
  }
  if(order=="Ascending"){
    d.order<-df[order(df$var),]
  }
  ranks<-1:length(df$var)
  d.rank<-cbind(d.order,ranks)
  names<-paste(d.rank$ranks,".",sep="")
  names<-paste(names,d.rank$city)
  d.graph<-cbind(d.rank,names)
  
  breaks <- classIntervals(d.graph$var,3,style="jenks")
  d.graph$color <- NA
  d.graph$color[d.graph$var<=breaks$brks[2]] <- "green"
  d.graph$color[d.graph$var>breaks$brks[2] & d.graph$var<=breaks$brks[3]] <- "yellow"
  d.graph$color[d.graph$var>breaks$brks[3]] <- "red"
  d.graph$round <- format(round(signif(d.graph$var, digits = sigfig), digits = num_dec), big.mark = if_else(thousands_comma == TRUE, ",", ""))
  d.graph$textfont <- "Museo Sans 300"
  d.graph$textfont[d.graph$city == "Louisville"] <- "Museo Sans 300 Italic"
  d.graph$linecolor <- "white"
  d.graph$linecolor[d.graph$city == "Louisville"] <- "#00a9b7"
  d.graph$textcolor <- "black"
  d.graph$textcolor[d.graph$city == "Louisville"] <- "#00a9b7"
  
  
  p <- ggplot(data=d.graph,aes(x=factor(names, levels=rev(unique(names))),
                               y=var,fill=factor(color)))+guides(fill=FALSE)
  p <- p+geom_bar(stat="identity",color=rev(d.graph$linecolor), size = 1)+coord_flip()+theme_tufte()
  if(order=="Ascending"){
    p <- p+scale_fill_manual(values=c("#96ca4f","#db2834","#ffd600"))
  }
  if(order=="Descending"){
    p <- p+scale_fill_manual(values=c("#db2834","#96ca4f","#ffd600"))
  }
  p <- p + theme(text = element_text(family = "Museo Sans 300"),
                 plot.title = element_text(size = 36, hjust = 0.5),
                 axis.text.y=element_text(hjust=0, family = rev(d.graph$textfont),
                                          size=24, color = rev(d.graph$textcolor)),
                 axis.ticks=element_blank(),
                 axis.text.x = element_blank(),
                 axis.title.x = element_text(size = 24),
                 plot.caption = element_text(size = 18),
                 plot.subtitle = element_text(size = 24, hjust = 0.5))
  
    if (text == TRUE) {
    p <-
      p + geom_text(
        aes(label = round),
        hjust = 1.1,
        size = 5,
        family = "Museo Sans 300"
      )
  }
  if (h_line == TRUE){
    p <- p + geom_hline(yintercept = 0, linetype = "longdash", size = 1)
  }
  p <- p+labs(title = plot_title, y= y_title,
              x = "", caption = caption_text)
  p
}
```

writing images
```{r}

jpeg("images/le_m_gap.jpg", 1800, 1200, res = 100)
showtext.begin()
rank_and_nb_group_h(
  health_df,
  "le_m_gap",
  order = "Ascending",
  plot_title = "Life Expectancy Gap Between Males \nin the Top and Bottom Income Quartiles",
  caption_text = "Source: Greater Louisville Project \nData from the Health Inequality Project"
)
showtext.end()
dev.off()

jpeg("images/le_f_gap.jpg", 1800, 1200, res = 100)
showtext.begin()
rank_and_nb_group_h(
  health_df,
  "le_f_gap",
  order = "Ascending",
  plot_title = "Life Expectancy Gap Between Females \nin the Top and Bottom Income Quartiles",
  caption_text = "Source: Greater Louisville Project \nData from the Health Inequality Project"
)
showtext.end()
dev.off()

jpeg("images/le_raceadj_m_gap.jpg", 1800, 1200, res = 100)
showtext.begin()
rank_and_nb_group_h(
  health_df,
  "le_raceadj_m_gap",
  order = "Ascending",
  plot_title = "Life Expectancy Gap Between Males \nin the Top and Bottom Income Quartiles (Race Adjusted)",
  caption_text = "Source: Greater Louisville Project \nData from the Health Inequality Project"
)
showtext.end()
dev.off()

jpeg("images/le_raceadj_f_gap.jpg", 1800, 1200, res = 100)
showtext.begin()
rank_and_nb_group_h(
  health_df,
  "le_raceadj_f_gap",
  order = "Ascending",
  plot_title = "Life Expectancy Gap Between Females \nin the Top and Bottom Income Quartiles (Race Adjusted)",
  caption_text = "Source: Greater Louisville Project \nData from the Health Inequality Project"
)
showtext.end()
dev.off()

jpeg("images/le_agg_q1_M.jpg", 1800, 1200, res = 100)
showtext.begin()
rank_and_nb_group_h(
  health_df,
  "le_agg_q1_M",
  order = "Descending",
  plot_title = "Life Expectancy of Males in the Bottom Income Quartiles",
  caption_text = "Source: Greater Louisville Project \nData from the Health Inequality Project"
)
showtext.end()
dev.off()

jpeg("images/le_agg_q1_F.jpg", 1800, 1200, res = 100)
showtext.begin()
rank_and_nb_group_h(
  health_df,
  "le_agg_q1_F",
  order = "Descending",
  plot_title = "Life Expectancy of Females in the Bottom Income Quartiles",
  caption_text = "Source: Greater Louisville Project \nData from the Health Inequality Project"
)
showtext.end()
dev.off()

jpeg("images/smoking.jpg", 1800, 1200, res = 100)
showtext.begin()
rank_and_nb_group_h(
  health_df,
  "smoke_gap",
  order = "Ascending",
  plot_title = "Gap in Smoking Rates between Top and Bottom Income Quintiles",
  caption_text = "Source: Greater Louisville Project \nData from the Health Inequality Project"
)
showtext.end()
dev.off()

jpeg("images/bmi.jpg", 1800, 1200, res = 100)
showtext.begin()
rank_and_nb_group_h(
  health_df,
  "bmi_gap",
  order = "Ascending",
  plot_title = "Gap in Obesity Rates between Top and Bottom Income Quintiles",
  caption_text = "Source: Greater Louisville Project \nData from the Health Inequality Project"
)
showtext.end()
dev.off()

jpeg("images/smoking_q1.jpg", 1800, 1200, res = 100)
showtext.begin()
rank_and_nb_group_h(
  health_df,
  "cur_smoke_q1",
  order = "Ascending",
  plot_title = "Smoking Rate in Bottom Income Quintiles",
  caption_text = "Source: Greater Louisville Project \nData from the Health Inequality Project"
)
showtext.end()
dev.off()

jpeg("images/bmi_q1.jpg", 1800, 1200, res = 100)
showtext.begin()
rank_and_nb_group_h(
  health_df,
  "bmi_obese_q1",
  order = "Ascending",
  plot_title = "Obesity Rate in Bottom Income Quintiles",
  caption_text = "Source: Greater Louisville Project \nData from the Health Inequality Project"
)
showtext.end()
dev.off()
```


Food security

Read in data
```{r}
insecurity <- read_feather("data/peer_food_insecurity_micro.feather")
```

The original data set contained observations for all of the United States. The data sec was trimmed to only peer cities using the following code.
```{r, eval = FALSE}
insecurity$city <- NA
insecurity$city[insecurity$METAREA == 3001] = "Grand Rapids"
insecurity$city[insecurity$METAREA == 7040] = "St. Louis"
insecurity$city[insecurity$METAREA == 5880] = "Oklahoma City"
insecurity$city[insecurity$METAREA == 8560] = "Tulsa"
insecurity$city[insecurity$METAREA == 3162] = "Greenville"
insecurity$city[insecurity$METAREA == 3840] = "Knoxville"
insecurity$city[insecurity$METAREA == 1001] = "Birmingham"
insecurity$city[insecurity$METAREA == 4520] = "Louisville"
insecurity$city[insecurity$METAREA == 3480] = "Indianapolis"
insecurity$city[insecurity$METAREA == 3760] = "Kansas City"
insecurity$city[insecurity$METAREA == 5921] = "Omaha"
insecurity$city[insecurity$METAREA == 3122] = "Greensboro"
insecurity$city[insecurity$METAREA == 1521] = "Charlotte"
insecurity$city[insecurity$METAREA == 1840] = "Columbus"
insecurity$city[insecurity$METAREA == 1641] = "Cincinnati"
insecurity$city[insecurity$METAREA == 5361] = "Nashville"
insecurity$city[insecurity$METAREA == 4920] = "Memphis"
insecurity$city[insecurity$METAREA == 3590] = "Jacksonville"
insecurity$city[insecurity$METAREA == 6642] = "Raleigh"
insecurity$city[insecurity$METAREA == 2002] = "Dayton"
insecurity$city[insecurity$METAREA == 6761] = "Richmond"

insecurity <- insecurity %>% filter(!is.na(city))

insecurity$baseline <- 1
insecurity$current <- 1

insecurity$baseline[insecurity$city %in% c("Grand Rapids", "St. Louis", "Oklahoma City", 
                                     "Tulsa", "Greenville", "Knoxville")] <- 0
insecurity$current[insecurity$city %in% c("Jacksonville", "Raleigh", "Dayton", "Richmond")] <-0

insecurity <- insecurity %>% filter(current == 1)
```

The FAMINC variable is coded into categories that occur in intervals of 2500, 5000, and 10000. Income is recoded to the lower value of the faminc variable.
```{r}

income <- data.frame(FAMINC = c(100, 210,  300,  430,   470,   500,   600,   710,   720,   730,   740,   820,   830,   841,    842,    843,    996, 997, 999),
                     inc    = c(1,   5000, 7500, 10000, 12500, 15000, 20000, 25000, 30000, 35000, 40000, 50000, 60000, 75000,  100000, 150000, NA,  NA,  NA))

insecurity <- left_join(insecurity, income)
```

The same household is included in the CPS multiple times, so multiple observations of the same individual are removed.
```{r}
insecurity <- insecurity[!duplicated(insecurity$CPSIDP),]
```

Calculate the number of children in each household is calculated and filter 
```{r}
insecurity %<>% add_count(CPSID)
```

The family's poverty status is based off of the lowest level of income in their income bracket. For example, the poverty threshold for a family of 4 in 2016 was 24,563. Families with incomes up to 25,000 are classified as in poverty. This biases the estimate of food security among those in poverty downward and the estimate for those not in poverty upward.
```{r}
insecurity$poverty <- 0
insecurity$poverty[insecurity$inc < 20000] <- 1
insecurity$poverty[insecurity$n >= 4 && insecurity$inc == 20000] <- 1
insecurity$poverty[insecurity$n >= 5 && insecurity$inc == 25000] <- 1
insecurity$poverty[insecurity$n >= 6 && insecurity$inc == 30000] <- 1
insecurity$poverty[insecurity$n >= 7 && insecurity$inc == 35000] <- 1
insecurity$poverty[insecurity$n >= 8 && insecurity$inc == 40000] <- 1
```

A dummy variable food_insecure is equal to 1 if the family is food insecure and 0 if not. Separate dummy variables are created for household food security and child food security.
```{r}
insecurity$food_insecure <- if_else(insecurity$FSSTATUS == 2 | insecurity$FSSTATUS == 3, 1, 0)
insecurity$food_insecure[insecurity$FSSTATUS == 98 | insecurity$FSSTATUS == 99] <- NA

insecurity$food_insecure_ch <- if_else(insecurity$FSSTATUSC == 2 | insecurity$FSSTATUSC == 3, 1, 0)
insecurity$food_insecure_ch[insecurity$FSSTATUSC == 98 | insecurity$FSSTATUSC == 99] <- NA

insecurity <- insecurity %>% filter(AGE<18)

```

Individual weight analysis
```{r}
fs_svy <- svydesign(ids = ~1, weights = ~WTSUPP, data = insecurity)

fs_svy_df <- svyby(~food_insecure, ~city+poverty, design = fs_svy, svymean, na.rm = TRUE) %>%
  select(city, poverty, food_insecure) %>%
  spread(key = poverty, value = food_insecure) %>%
  rename(poor_food_insecure = `1`, not_poor_food_insecure = `0`)

fs_svy_df$poor_food_insecure <- rescale(fs_svy_df$poor_food_insecure)
fs_svy_df$not_poor_food_insecure <- rescale(fs_svy_df$not_poor_food_insecure)
```

```{r}
jpeg("images/ccu17_food_security.jpg", 1800, 1200, res = 100)
rank_and_nb_group(fs_svy_df, "poor_food_insecure", order = "Ascending",
                  plot_title = "Poor children living in housheolds that are food insecure",
                  caption_text = "Source: Greater Louisville Project Analysis of\nCurrent Population Survey Microdata Data via IPUMS")
dev.off()
```


```{r, message = FALSE}
transit_data <- read_csv("data/ACS_15_1YR_S0802_with_ann.csv", skip=1, col_types = cols("Id2" = col_double()))

transit_data <- transit_data %>% rename(FIPS = Id2) %>% mutate(year = 2015)

transit_data <- pull_peers_FIPS(transit_data)

transit_data <- transit_data %>%
  transmute(
    FIPS = FIPS,
    year = year,
    
    #total numbers
    total = `Total; Estimate; POVERTY STATUS IN THE PAST 12 MONTHS - Workers 16 years and over for whom poverty status is determined`,
    total_public = `Public transportation (excluding taxicab); Estimate; POVERTY STATUS IN THE PAST 12 MONTHS - Workers 16 years and over for whom poverty status is determined`,
    
    #poor percents
    pct_pov = `Total; Estimate; POVERTY STATUS IN THE PAST 12 MONTHS - Workers 16 years and over for whom poverty status is determined - Below 100 percent of the poverty level`,
    public_pct_pov = `Public transportation (excluding taxicab); Estimate; POVERTY STATUS IN THE PAST 12 MONTHS - Workers 16 years and over for whom poverty status is determined - Below 100 percent of the poverty level`,
    
    #slightly above poverty public transit percent
    pct_pov150 = `Total; Estimate; POVERTY STATUS IN THE PAST 12 MONTHS - Workers 16 years and over for whom poverty status is determined - 100 to 149 percent of the poverty level`,
    public_pct_pov150 = `Public transportation (excluding taxicab); Estimate; POVERTY STATUS IN THE PAST 12 MONTHS - Workers 16 years and over for whom poverty status is determined - 100 to 149 percent of the poverty level`,
    
    #above poverty public transit percent
    pct_nonpov = `Total; Estimate; POVERTY STATUS IN THE PAST 12 MONTHS - Workers 16 years and over for whom poverty status is determined - At or above 150 percent of the poverty level`,
    public_pct_nonpov = `Public transportation (excluding taxicab); Estimate; POVERTY STATUS IN THE PAST 12 MONTHS - Workers 16 years and over for whom poverty status is determined - At or above 150 percent of the poverty level`
    ) %>%
  mutate_all(as.numeric) %>%
  transmute(
    FIPS = as.character(FIPS),
    year = as.character(year),
  
  pct_public = 
    (total / total_public) * 100,
    
  pov_pct_public = 
    ((public_pct_pov * total_public) * 100/ 
    (pct_pov * total)),
    
  nonpov_pct_public = 
    ((public_pct_pov150 * total_public + public_pct_nonpov * total_public) * 100/ 
    (pct_pov150 * total + pct_nonpov * total))
  )

#Apply FIPS codes names
names <- read_csv("data/FIPS two stl.csv")
names$FIPS <- as.character(names$FIPS)
transit_data <- left_join(transit_data, names, by = "FIPS")

##Add population data
population_data <- read_csv("data/population_data.csv")
population_data$FIPS <- as.character(population_data$FIPS)
transit_data$year <- as.integer(transit_data$year)
transit_data <- left_join(transit_data, population_data, by = c("FIPS", "year"))

##Merge St. Louis city and St. Louis county
transit_data <- transit_data %>%
  select(-county, -state, -weights, -FIPS, -year) %>%
  group_by(city) %>%
  summarise_each(funs(weighted.mean(.,population)), -population) %>%
  ungroup()
```

```{r}
output_df <- left_join(graph_df, ch_pov_df, by = "city")

output_df <- output_df %>% rename(per_child_pov = income_poverty)

output_df$per_child_pov <- rescale(output_df$per_child_pov)

write_csv(output_df, "output.csv")

```





